<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>THIRAN Result Viewer</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input {
        padding: 10px;
        font-size: 16px;
        width: 250px;
        margin-bottom: 12px;
    }
    button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #444;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #f0f0f0;
    }
</style>
</head>

<body>

<h2>THIRAN Result Viewer</h2>

<input id="emisInput" placeholder="Enter EMIS Number">
<button onclick="searchStudent()">Search</button>

<div id="resultContainer"></div>

<script>
/* -----------------------------
   CONFIG
------------------------------*/
const SHEET_ID = "17Lupgg8a6AKXfcu_WrSElxfZ1XKuxS1O8bBXpEv5DM4";
const SHEET_NAME = "Sheet1";

const GVIZ_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* -----------------------------
   FETCH SHEET
------------------------------*/
async function fetchSheet() {
    try {
        const response = await fetch(GVIZ_URL);
        const text = await response.text();
        const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
        return json.table;
    } catch (err) {
        alert("Error fetching sheet. Ensure it is published.");
        return null;
    }
}

/* -----------------------------
   SEARCH STUDENT
------------------------------*/
function searchStudent() {
    const emis = document.getElementById("emisInput").value.trim();
    if (!emis) return alert("Enter an EMIS number");

    const table = window.DATA;
    if (!table) return;

    // Column indexes
    const col = {
        emis: 0,
        class: 1,
        section: 2,
        name: 3,
        maths: 4,
        english: 5,
        tamil: 6,
        total: 7
    };

    // Find student
    const row = table.rows.find(r => {
        let cell = r.c[col.emis];
        return cell && String(cell.v).trim() === emis;
    });

    if (!row) {
        document.getElementById("resultContainer").innerHTML = "<p>No student found.</p>";
        return;
    }

    const name = row.c[col.name]?.v || "";
    const cls = row.c[col.class]?.v || "";
    const sec = row.c[col.section]?.v || "";
    const maths = row.c[col.maths]?.v || "";
    const english = row.c[col.english]?.v || "";
    const tamil = row.c[col.tamil]?.v || "";
    const total = row.c[col.total]?.v || "";

    // Build HTML
    let html = `
        <h3>Student Details</h3>
        <p><b>Name:</b> ${name}</p>
        <p><b>Class:</b> ${cls}</p>
        <p><b>Section:</b> ${sec}</p>
        <p><b>EMIS Number:</b> ${emis}</p>

        <h3>Marks</h3>
        <table>
            <tr>
                <th>Maths</th>
                <th>English</th>
                <th>Tamil</th>
                <th>Total</th>
            </tr>
            <tr>
                <td>${maths}</td>
                <td>${english}</td>
                <td>${tamil}</td>
                <td>${total}</td>
            </tr>
        </table>
    `;

    document.getElementById("resultContainer").innerHTML = html;
}

/* -----------------------------
   INIT
------------------------------*/
async function init() {
    const data = await fetchSheet();
    if (!data) return;
    window.DATA = data;
}

init();
</script>

</body>
</html>
