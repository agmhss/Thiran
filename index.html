<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>THIRAN Result Viewer</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input {
        padding: 10px;
        font-size: 16px;
        width: 250px;
        margin-bottom: 12px;
    }
    button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #444;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #f0f0f0;
    }
</style>
</head>

<body>

<h2>THIRAN Result Viewer</h2>

<input id="emisInput" placeholder="Enter EMIS Number">
<button onclick="searchStudent()">Search</button>

<div id="resultContainer"></div>

<script>
/* -----------------------------
   CONFIG
------------------------------*/
const SHEET_ID = "17Lupgg8a6AKXfcu_WrSElxfZ1XKuxS1O8bBXpEv5DM4";
const SHEET_NAME = "Sheet1";

const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* -----------------------------
   FETCH SHEET
------------------------------*/
async function fetchSheet() {
    try {
        const response = await fetch(GVIZ_URL);
        const text = await response.text();
        const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
        return json.table;
    } catch (err) {
        alert("Error fetching sheet. Ensure it is published.");
        return null;
    }
}

/* -----------------------------
   DETECT EXAM BLOCKS (Emis No â†’ Total)
------------------------------*/
function detectExamBlocks(cols) {
    let blocks = [];
    let start = null;

    for (let i = 0; i < cols.length; i++) {
        const name = cols[i].label.trim().toLowerCase();

        if (name === "emis no" || name === "emisno") start = i;
        if (name === "total" && start !== null) {
            blocks.push({ startCol: start, endCol: i });
            start = null;
        }
    }
    return blocks;
}

/* -----------------------------
   FIND COLUMN INDEXES
------------------------------*/
function findColumnIndexes(cols) {
    let indices = {
        emis: null,
        name: null,
        class: null,
        section: null
    };

    cols.forEach((col, index) => {
        let label = col.label.trim().toLowerCase();

        if (label === "emis no" || label === "emisno") indices.emis = index;
        if (label === "name" || label === "student name") indices.name = index;
        if (label === "class" || label === "std") indices.class = index;
        if (label === "section" || label === "sec") indices.section = index;
    });

    return indices;
}

/* -----------------------------
   SEARCH STUDENT AND DISPLAY ALL EXAMS
------------------------------*/
function searchStudent() {
    const emis = document.getElementById("emisInput").value.trim();
    if (!emis) return alert("Enter an EMIS number");

    const table = window.DATA;
    const blocks = window.BLOCKS;
    const idx = window.COLIDX;

    // Find student row
    const studentRow = table.rows.find(r => {
        let cell = r.c[idx.emis];
        return cell && String(cell.v).trim() === emis;
    });

    if (!studentRow) {
        document.getElementById("resultContainer").innerHTML = "<p>No student found.</p>";
        return;
    }

    /* -----------------------------
       Extract student info
    ------------------------------*/
    const name = studentRow.c[idx.name]?.v || "N/A";
    const cls = studentRow.c[idx.class]?.v || "N/A";
    const sec = studentRow.c[idx.section]?.v || "N/A";

    /* -----------------------------
       Build Output
    ------------------------------*/
    let html = `
        <h3>Student Details</h3>
        <p><b>Name:</b> ${name}</p>
        <p><b>Class:</b> ${cls}</p>
        <p><b>Section:</b> ${sec}</p>
        <p><b>EMIS Number:</b> ${emis}</p>

        <h3>Exam Results</h3>
        <table>
        <tr><th>Exam</th><th>Maths</th><th>English</th><th>Tamil</th><th>Total</th></tr>
    `;

    blocks.forEach((block, index) => {
        const maths = studentRow.c[block.startCol + 4]?.v || "";
        const english = studentRow.c[block.startCol + 5]?.v || "";
        const tamil = studentRow.c[block.startCol + 6]?.v || "";
        const total = studentRow.c[block.startCol + 7]?.v || "";

        html += `
            <tr>
                <td>Exam ${index + 1}</td>
                <td>${maths}</td>
                <td>${english}</td>
                <td>${tamil}</td>
                <td>${total}</td>
            </tr>
        `;
    });

    html += "</table>";

    document.getElementById("resultContainer").innerHTML = html;
}

/* -----------------------------
   MAIN INIT
------------------------------*/
async function init() {
    const data = await fetchSheet();
    if (!data) return;

    window.DATA = data;
    window.BLOCKS = detectExamBlocks(data.cols);
    window.COLIDX = findColumnIndexes(data.cols);
}

init();
</script>

</body>
</html>
