<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THIRAN Result Viewer – Class 6-9</title>
  <style>
    :root {
      --primary:#2563eb;
      --accent:#f97316;
      --bg-dark:#020617;
      --card-bg:rgba(15,23,42,0.96);
      --text-main:#e5e7eb;
      --pill-bg:#0f172a;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      min-height:100vh;
      font-family:system-ui,sans-serif;
      background:radial-gradient(circle at top,#1d4ed8 0,#020617 45%,#020617 100%);
      color:var(--text-main);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .container{
      max-width:1000px;width:100%;
      background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(8,47,73,0.98));
      border-radius:24px;
      padding:20px;
      box-shadow:0 24px 70px rgba(0,0,0,0.6);
      position:relative;overflow:hidden;
    }
    h1{font-size:clamp(1.6rem,3.2vw,2.2rem);display:flex;align-items:center;gap:10px;color:#f9fafb;}
    h1 span.logo{
      width:42px;height:42px;border-radius:50%;
      background:radial-gradient(#fde68a,#f97316);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;box-shadow:0 0 22px rgba(251,191,36,0.8);
    }
    .card{
      background:var(--card-bg);
      border-radius:18px;
      padding:16px;
      border:1px solid rgba(148,163,184,0.4);
      margin-bottom:16px;
    }
    .form-grid{
      display:grid;grid-template-columns:1fr 2fr 1fr;
      gap:12px;align-items:end;margin-top:12px;
    }
    label{font-size:0.9rem;color:#e5e7eb;}
    input[type=text]{
      width:100%;padding:10px 14px;border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.94);color:#e5e7eb;outline:none;
    }
    input:focus{
      border-color:#4ade80;
      box-shadow:0 0 0 2px rgba(74,222,128,0.3);
    }
    .exam-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;}
    .exam-pill{
      padding:6px 12px;border-radius:999px;
      background:var(--pill-bg);
      border:1px solid rgba(148,163,184,0.6);
      cursor:pointer;font-size:0.85rem;
      display:inline-flex;align-items:center;gap:6px;
      color:#e5e7eb;
    }
    .exam-pill input{accent-color:#f97316;}
    .exam-pill:hover{border-color:#fbbf24;background:#020617;}
    button{
      background:linear-gradient(135deg,#f97316,#facc15);
      color:#111;padding:12px;border:none;border-radius:999px;
      font-weight:600;cursor:pointer;width:100%;
      box-shadow:0 12px 30px rgba(0,0,0,0.45);
    }
    button:hover{filter:brightness(1.05);}
    #status{margin-top:10px;color:#facc15;font-size:0.9rem;min-height:1.4em;}
    .result-card{
      background:var(--card-bg);
      border-radius:16px;
      padding:16px;
      border:1px solid rgba(148,163,184,0.4);
    }
    .student-meta{
      background:rgba(15,23,42,0.6);
      padding:12px;border-radius:10px;margin-bottom:12px;
      display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:8px;font-size:0.92rem;
    }
    .student-meta strong{color:#facc15;}
    table{
      width:100%;border-collapse:collapse;margin-top:10px;
      font-size:0.88rem;background:rgba(15,23,42,0.98);
      border-radius:12px;overflow:hidden;
    }
    thead{
      background:linear-gradient(90deg,#0ea5e9,#22c55e);
      color:#fff;
    }
    th,td{padding:10px;text-align:center;}
    th:first-child,td:first-child{text-align:left;font-weight:600;}
    tbody tr:nth-child(even){background:rgba(15,23,42,0.96);}
    tbody tr:nth-child(odd){background:rgba(15,23,42,0.9);}
    .total-row td{
      background:rgba(30,64,175,0.9)!important;
      font-weight:700;color:#fbbf24;
    }
    @media (max-width:840px){
      .form-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="logo">★</span> THIRAN Result Viewer</h1>
    <div class="card">
      <div style="margin-bottom:12px; color:#cbd5f5;">
        Enter your <strong style="color:#facc15;">EMIS Number</strong> and select exams
      </div>
      <div class="form-grid">
        <div>
          <label>EMIS Number</label>
          <input id="emisInput" type="text" placeholder="e.g. 3312345678" />
        </div>
        <div>
          <label>Select Exams</label>
          <div id="examOptions" class="exam-options">Loading exams...</div>
        </div>
        <div>
          <button id="showBtn">Show Results</button>
        </div>
      </div>
      <div id="status"></div>
    </div>

    <div id="resultArea" style="display:none;" class="result-card">
      <h2>Marks Comparison <small id="examLabels"></small></h2>
      <div class="student-meta">
        <span><strong>Name:</strong> <span id="sName">—</span></span>
        <span><strong>EMIS:</strong> <span id="sEmis">—</span></span>
        <span><strong>Class:</strong> <span id="sClass">—</span></span>
        <span><strong>Section:</strong> <span id="sSec">—</span></span>
      </div>
      <div id="tableWrapper"></div>
    </div>
  </div>

  <script>
    const SHEET_ID   = "17Lupgg8a6AKXfcu_WrSElxfZ1XKuxS1O8bBXpEv5DM4";
    const SHEET_NAME = "Sheet1";

    const EXAM_NAMES = [
      "July 2025","August 2025","September 2025",
      "November 2025","December 2025",
      "January 2026","February 2026","March 2026","Extra 1","Extra 2"
    ];

    let exams = [];
    let sheetRows = [];

    const status = document.getElementById("status");
    const examOptions = document.getElementById("examOptions");

    async function loadSheet() {
      status.textContent = "Connecting to Google Sheets...";
      const url =
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}` +
        `/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Network error");
        let text = await resp.text();

        const start = text.indexOf("{");
        const end   = text.lastIndexOf("}") + 1;
        if (start === -1 || end === 0) throw new Error("Invalid JSON response");

        text = text.substring(start, end);
        const data = JSON.parse(text);

        const cols = data.table.cols.map(c => (c?.label || "").trim());
        sheetRows  = data.table.rows.map(r => r.c?.map(cell => cell?.v ?? null) || []);

        if (sheetRows.length === 0) throw new Error("Sheet is empty");

        detectExamBlocks(cols);
      } catch (err) {
        console.error(err);
        status.textContent =
          "Failed to load data. Check Sheet ID, tab name and sharing.";
        examOptions.innerHTML = "Error loading sheet";
      }
    }

    function detectExamBlocks(headers) {
      exams = [];
      let blockId = 0;

      for (let i = 0; i < headers.length; i++) {
        if (headers[i] && headers[i].toLowerCase().includes("emis no")) {
          const start = i;
          const nextEmis =
            headers.slice(i + 1).findIndex(h => h?.toLowerCase().includes("emis no"));
          const end = nextEmis === -1 ? headers.length - 1 : i + nextEmis + 1;

          const block = {
            label: EXAM_NAMES[blockId] || `Exam ${blockId + 1}`,
            emisCol: i,
            nameCol: null,
            classCol: null,
            secCol: null,
            totalCol: null,
            subjects: []
          };

          for (let c = start + 1; c <= end; c++) {
            const rawLabel = headers[c] || "";
            const label = rawLabel.toLowerCase();

            if (label.includes("name") && !label.includes("emis")) {
              block.nameCol = c;
            } else if (label.includes("class") && !label.includes("sec")) {
              // Class only
              block.classCol = c;
            } else if (label.includes("sec") || label.includes("section")) {
              block.secCol = c;
            } else if (label.includes("total") && !label.includes("rank")) {
              block.totalCol = c;
            } else if (
              rawLabel &&
              !label.includes("emis") &&   // avoid EMIS columns becoming subjects
              !["rank","s.no","sl.no"].some(x => label.includes(x))
            ) {
              block.subjects.push({ name: rawLabel, col: c });
            }
          }

          if (block.nameCol !== null && block.totalCol !== null && block.subjects.length > 0) {
            exams.push(block);
            blockId++;
          }
        }
      }

      if (exams.length === 0) {
        status.textContent =
          "No exam blocks detected. Each block must start with an 'EMIS NO' column.";
        examOptions.innerHTML = "No exams found";
        return;
      }

      renderExamCheckboxes();
      status.textContent = `Ready! Found ${exams.length} exam blocks.`;
    }

    function renderExamCheckboxes() {
      examOptions.innerHTML = "";
      exams.forEach((exam, idx) => {
        const lbl = document.createElement("label");
        lbl.className = "exam-pill";
        lbl.innerHTML =
          `<input type="checkbox" value="${idx}"> <span>${exam.label}</span>`;
        examOptions.appendChild(lbl);
      });
    }

    document.getElementById("showBtn").onclick = showResults;
    document
      .getElementById("emisInput")
      .addEventListener("keypress", e => e.key === "Enter" && showResults());

    function showResults() {
      const emis = document.getElementById("emisInput").value.trim();
      if (!emis) {
        status.textContent = "Enter EMIS number";
        return;
      }

      const selected = Array.from(
        examOptions.querySelectorAll("input:checked")
      ).map(cb => parseInt(cb.value, 10));

      if (selected.length === 0) {
        status.textContent = "Select at least one exam";
        return;
      }

      let name = "";
      let cls  = "";
      let sec  = "";
      const results = [];

      selected.forEach(idx => {
        const exam = exams[idx];

        const row = sheetRows.find(
          r => r[exam.emisCol] != null && String(r[exam.emisCol]).trim() === emis
        );

        if (row) {
          if (!name && exam.nameCol !== null) name = row[exam.nameCol] || "";
          if (!cls && exam.classCol !== null)  cls  = row[exam.classCol]  || "";
          if (!sec && exam.secCol  !== null)   sec  = row[exam.secCol]   || "";

          const marks = {};
          exam.subjects.forEach(s => {
            marks[s.name] = row[s.col] ?? "";
          });

          results.push({
            exam: exam.label,
            total: row[exam.totalCol] ?? "",
            marks
          });
        } else {
          results.push({ exam: exam.label, total: "-", marks: {} });
        }
      });

      if (results.every(r => r.total === "-")) {
        status.textContent = "EMIS number not found in selected exams";
        document.getElementById("resultArea").style.display = "none";
        return;
      }

      renderTable(name, emis, cls, sec, results);
      document.getElementById("resultArea").style.display = "block";
      status.textContent = "";
    }

    function renderTable(name, emis, cls, sec, results) {
      const allSubjects = new Set();
      results.forEach(r => Object.keys(r.marks).forEach(s => allSubjects.add(s)));
      const subjects = Array.from(allSubjects);

      let html = `<table><thead><tr><th>Subject</th>`;
      results.forEach(r => (html += `<th>${r.exam}</th>`));
      html += `</tr></thead><tbody>`;

      subjects.forEach(sub => {
        html += `<tr><td>${sub}</td>`;
        results.forEach(r => {
          const mark = r.marks[sub] ?? "-";
          html += `<td>${mark}</td>`;
        });
        html += `</tr>`;
      });

      html += `<tr class="total-row"><td>TOTAL</td>`;
      results.forEach(r => (html += `<td>${r.total}</td>`));
      html += `</tr></tbody></table>`;

      document.getElementById("sName").textContent = name || "—";
      document.getElementById("sEmis").textContent = emis;
      document.getElementById("sClass").textContent = cls || "—";
      document.getElementById("sSec").textContent   = sec || "—";
      document.getElementById("examLabels").textContent =
        results.map(r => r.exam).join(" vs ");
      document.getElementById("tableWrapper").innerHTML = html;
    }

    loadSheet();
  </script>
</body>
</html>
