<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Class 6 to 9 THIRAN ‚Äì Multi-Exam Result Viewer</title>
  <style>
    :root {
      --primary: #2563eb;
      --accent: #f97316;
      --bg-dark: #020617;
      --card-bg: rgba(15,23,42,0.96);
      --text-main: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(8,47,73,0.98));
      border-radius: 24px;
      box-shadow: 0 24px 70px rgba(15,23,42,0.9);
      padding: 20px 18px 22px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(96,165,250,0.28), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(251,191,36,0.24), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(34,197,94,0.18), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.6rem, 3.2vw, 2.2rem);
      display: flex;
      align-items: center;
      gap: 10px;
      color: #f9fafb;
    }

    h1 span.logo {
      display: inline-flex;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0%, #fde68a, #f97316);
      box-shadow: 0 0 22px rgba(251,191,36,0.8);
      font-size: 22px;
    }

    .subtitle {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 18px 45px rgba(15,23,42,0.9);
      margin-bottom: 14px;
      animation: fadeInUp 0.5s ease-out;
    }

    .welcome {
      font-size: 0.9rem;
      color: #cbd5f5;
      margin-bottom: 6px;
    }

    .welcome span {
      color: #facc15;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,2fr) minmax(0,1.2fr);
      gap: 12px;
      align-items: end;
      margin-top: 8px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #cbd5f5;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    input[type="text"] {
      width: 100%;
      border-radius: 999px;
      padding: 9px 13px;
      font-size: 0.95rem;
      border: 1px solid rgba(148,163,184,0.7);
      outline: none;
      background: rgba(15,23,42,0.94);
      color: #e5e7eb;
      transition: border 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    input[type="text"]:focus {
      border-color: #4ade80;
      box-shadow: 0 0 0 1px rgba(74,222,128,0.7);
      background: rgba(15,23,42,0.98);
    }

    ::placeholder {
      color: #64748b;
    }

    .exam-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .exam-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.16s ease, border 0.16s ease, transform 0.12s ease;
    }

    .exam-pill input {
      accent-color: #facc15;
      cursor: pointer;
    }

    .exam-pill span {
      padding-top: 1px;
    }

    .exam-pill:hover {
      transform: translateY(-1px);
      border-color: #fbbf24;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.96rem;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at 10% -10%, #f97316, #facc15);
      color: #111827;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(251,191,36,0.6);
      width: 100%;
      transition: transform 0.16s ease, box-shadow 0.16s ease, filter 0.16s ease;
    }

    button span.icon {
      font-size: 1.1rem;
    }

    button:hover {
      transform: translateY(-1px) scale(1.01);
      filter: brightness(1.05);
      box-shadow: 0 16px 40px rgba(251,191,36,0.8);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 16px rgba(251,191,36,0.7);
    }

    #status {
      margin-top: 6px;
      min-height: 1.2em;
      font-size: 0.84rem;
      color: #facc15;
    }

    .result-wrapper {
      display: grid;
      grid-template-columns: minmax(0,2.5fr) minmax(0,1.4fr);
      gap: 12px;
    }

    .result-card,
    .comment-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 12px 14px 14px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 18px 45px rgba(15,23,42,0.9);
      animation: fadeInUp 0.5s ease-out;
    }

    .result-card h2,
    .comment-card h2 {
      margin: 0 0 6px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #f9fafb;
    }

    .result-card h2 span {
      font-size: 0.8rem;
      color: #a5b4fc;
      font-weight: 400;
    }

    .student-meta {
      font-size: 0.86rem;
      color: #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .student-meta strong {
      color: #facc15;
    }

    table {
      table-layout: auto; 
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.8rem;
      background: rgba(15,23,42,0.98);
      border-radius: 12px;
      overflow: hidden;

    }

    thead {
      background: linear-gradient(90deg, #0ea5e9, #22c55e);
      color: #0f172a;
    }

    th, td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid rgba(30,64,175,0.85);
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.96);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.45);
    }

    .row-label {
      text-align: left;
      font-weight: 600;
      color: #e5e7eb;
    }

    .total-row td {
      font-weight: 700;
      color: #fbbf24;
      background: rgba(30,64,175,0.85);
      border-top: 1px solid rgba(148,163,184,0.7);
    }

    .rank-row td {
      font-weight: 700;
      color: #facc15;
      background: rgba(30,64,175,0.7);
    }

    .comment-card textarea {
      width: 100%;
      min-height: 120px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 8px 10px;
      font-size: 0.9rem;
      resize: vertical;
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      outline: none;
      transition: border 0.18s ease, box-shadow 0.18s ease;
    }

    .comment-card textarea:focus {
      border-color: #fb923c;
      box-shadow: 0 0 0 1px rgba(251,146,60,0.75);
    }

    .comment-hint {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #cbd5f5;
      opacity: 0.85;
    }

    .star {
      position: fixed;
      bottom: -20px;
      font-size: 22px;
      color: #facc15;
      text-shadow:
        0 0 8px rgba(250,204,21,0.9),
        0 0 14px rgba(250,204,21,0.9);
      opacity: 0;
      pointer-events: none;
      animation: flyUp 1.8s ease-out forwards;
      z-index: 50;
    }

    @keyframes flyUp {
      0% {
        transform: translateY(0) scale(0.7) rotate(0deg);
        opacity: 0;
      }
      15% {
        opacity: 1;
      }
      50% {
        transform: translateY(-40vh) scale(1.05) rotate(12deg);
      }
      100% {
        transform: translateY(-115vh) scale(0.95) rotate(-8deg);
        opacity: 0;
      }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 840px) {
      .container { padding: 16px 14px 18px; border-radius: 22px; }
      .form-grid {
        grid-template-columns: minmax(0,1fr);
      }
      .result-wrapper {
        grid-template-columns: minmax(0,1fr);
      }
      h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <div>
        <h1>
          <span class="logo">‚òÖ</span>
          AGMHSS PATTEESWARAM, THIRAN Result Dashboard
        </h1>
        <div class="subtitle">
          Welcome Class 6 to 9 Students! Enter your EMIS number and choose the months to see your performance side-by-side.
        </div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        Live marks from Google Sheets
      </div>
    </div>

    <!-- INPUT CARD -->
    <div class="card">
      <div class="welcome">
        Dear student, please enter your <span>Exam Number</span> and select one or more exams.
      </div>
      <div class="form-grid">
        <div>
          <label for="examNoInput">Exam Number</label>
          <input id="examNoInput" type="text" placeholder="e.g. 8101" />
        </div>
        <div>
          <label>Exams to Compare</label>
          <div id="examOptions" class="exam-options">
            Loading exam list...
          </div>
        </div>
        <div>
          <button id="showBtn">
            <span class="icon">üöÄ</span>
            Show My Performance
          </button>
        </div>
      </div>
      <div id="status"></div>
    </div>

    <!-- RESULT + COMMENTS -->
    <div id="resultArea" style="display:none;">
      <div class="result-wrapper">
        <div class="result-card">
          <h2>
            Marks Comparison
            <span id="examLabelSmall"></span>
          </h2>
          <div class="student-meta">
            <span><strong>Name:</strong> <span id="studentName"></span></span>
            <span><strong>Emis No:</strong> <span id="studentEmisNo"></span></span>
          </div>
          <div id="tableWrapper"></div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /******************* CONFIG ‚Äì EDIT THIS *******************/
    const SHEET_ID   = "1RkGzPu3KkP5FRZqPMgmIYVbu2--y-NobJMpbNo-GgIc";   // ‚Üê paste only the ID, not the whole URL
    const SHEET_NAME = "Thiran";                // tab name

    // Exam display names by block order (block 4+ optional ‚Äì you can add more)
    const EXAM_NAMES = [
      "July",
      "August",
      "September",
      "November",   // block 4 ‚Äì when you add it
    ];
    /*********************************************************/

    let sheetCols = [];
    let sheetRows = [];
    let exams = []; // detected exam blocks

    const examNoInput = document.getElementById("examNoInput");
    const showBtn     = document.getElementById("showBtn");
    const statusEl    = document.getElementById("status");
    const examOptions = document.getElementById("examOptions");
    const resultArea  = document.getElementById("resultArea");
    const tableWrapper = document.getElementById("tableWrapper");
    const studentNameEl = document.getElementById("studentName");
    const studentExamNoEl = document.getElementById("studentExamNo");
    const examLabelSmall = document.getElementById("examLabelSmall");

    document.addEventListener("DOMContentLoaded", () => {
      loadSheetData();
      showBtn.addEventListener("click", onShowClick);
      emisNoInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") onShowClick();
      });
    });

    async function loadSheetData() {
      try {
        statusEl.textContent = "Connecting to Google Sheets...";
        const url =
          "https://docs.google.com/spreadsheets/d/" +
          SHEET_ID +
          "/gviz/tq?tqx=out:json&sheet=" +
          encodeURIComponent(SHEET_NAME);

        const res = await fetch(url);
        const text = await res.text();

        const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
        const table = json.table;

        sheetCols = (table.cols || []).map(c => (c.label || ""));
        sheetRows = (table.rows || []).map(r => (r.c || []).map(cell => cell ? cell.v : null));

        if (!sheetRows.length) {
          statusEl.textContent = "No data rows found in sheet.";
          examOptions.textContent = "No data.";
          return;
        }

        detectExamBlocks();
        if (!exams.length) {
          statusEl.textContent = "Could not detect exam blocks. Check that each block starts with 'EXAM NO' in the header row.";
          examOptions.textContent = "No exams found.";
          return;
        }

        buildExamOptions();
        statusEl.textContent = "Ready. Enter your Emis Number and choose the exams.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading data. Check Sheet ID / publishing / sharing settings.";
        examOptions.textContent = "Error loading.";
      }
    }

    // NEW: detect exam blocks wherever header label is "EXAM NO"
    function detectExamBlocks() {
      exams = [];
      const headers = sheetCols.map(h => (h || "").trim());
      const starts = [];

      headers.forEach((lbl, idx) => {
        if (lbl.toLowerCase().startsWith("emis no")) {
          starts.push(idx);
        }
      });

      if (!starts.length) return;

      for (let bi = 0; bi < starts.length; bi++) {
        const start = starts[bi];
        const end = (bi + 1 < starts.length ? starts[bi + 1] : headers.length) - 1;

        let examNoIndex = start;
        let nameIndex = null;
        let totalIndex = null;
        const subjects = [];

        for (let c = start + 1; c <= end; c++) {
          const label = headers[c];
          if (!label) continue;

          const lower = label.toLowerCase();
          if (lower === "name") {
            nameIndex = c;
          } else if (lower.includes("total")) {
            totalIndex = c;
          } else if (!lower.includes("rank")) {
            subjects.push({ name: label, colIndex: c });
          }
        }

        if (nameIndex == null || totalIndex == null || !subjects.length) {
          continue; // skip malformed block
        }

       const configuredName = EXAM_NAMES[bi] || ("Exam " + (bi + 1));

        exams.push({
          id: configuredName,
          label: configuredName,
          startCol: start,
          endCol: end,
          emisNoIndex,
          nameIndex,
          totalIndex,
          subjects
        });
      }
    }

    function buildExamOptions() {
      if (!exams.length) {
        examOptions.textContent = "No exams found.";
        return;
      }
      examOptions.innerHTML = "";
      exams.forEach((exam, idx) => {
        const label = document.createElement("label");
        label.className = "exam-pill";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = idx;
        checkbox.checked = false;

        const span = document.createElement("span");
        span.textContent = exam.label;

        label.appendChild(checkbox);
        label.appendChild(span);
        examOptions.appendChild(label);
      });
    }

    function onShowClick() {
      if (!sheetRows.length || !exams.length) {
        statusEl.textContent = "Data not ready yet.";
        return;
      }

      const emisNo = (emisNoInput.value || "").trim();
      if (!emisNo) {
        statusEl.textContent = "Please enter your Emis Number.";
        resultArea.style.display = "none";
        launchStars(false);
        return;
      }

      const selectedExamIndexes = [];
      examOptions.querySelectorAll("input[type='checkbox']").forEach(cb => {
        if (cb.checked) selectedExamIndexes.push(Number(cb.value));
      });

      if (!selectedExamIndexes.length) {
        statusEl.textContent = "Please select at least one exam.";
        resultArea.style.display = "none";
        launchStars(false);
        return;
      }

      const dataRows = sheetRows; // first row is already student data (headers are in sheetCols)

      const examResults = [];
      let studentName = "";

      selectedExamIndexes.forEach(idx => {
        const exam = exams[idx];
        const res = findStudentInExam(dataRows, exam, emisNo);
        if (res && !studentName && res.name) {
          studentName = res.name;
        }
        examResults.push({ exam, result: res });
      });

      if (!studentName && examResults.every(er => !er.result)) {
        statusEl.textContent = "Exam Number not found in the selected exams.";
        resultArea.style.display = "none";
        launchStars(false);
        return;
      }

      statusEl.textContent = "";
      renderResultTable(examNo, studentName, examResults);
      launchStars(true);
    }

    function findStudentInExam(dataRows, exam, emisNoInput) {
      const examNoIdx = exam.emisNoIndex;
      const nameIdx   = exam.nameIndex;
      const totalIdx  = exam.totalIndex;
      const subjects  = exam.subjects;

      let studentRowIndex = -1;
      let studentRow = null;

      for (let i = 0; i < dataRows.length; i++) {
        const row = dataRows[i];
        const value = row[emisNoIdx];
        if (value == null) continue;
        const cellEmisNo = String(value).trim();
        if (cellEmisNo === emisNoInput) {
          studentRowIndex = i;
          studentRow = row;
          break;
        }
      }

      if (studentRowIndex === -1 || !studentRow) {
        return null;
      }

      const name = studentRow[nameIdx] != null ? String(studentRow[nameIdx]) : "";
      const totalRaw = studentRow[totalIdx];
      const total = totalRaw != null ? totalRaw : "";

      const subjectMarks = {};
      subjects.forEach(sub => {
        const v = studentRow[sub.colIndex];
        subjectMarks[sub.name] = (v != null ? v : "");
      });

      const rank = calculateRankForExam(dataRows, exam, String(studentRow[emisNoIdx]).trim(), totalRaw);

      return { name, emisNo: String(studentRow[emisNoIdx]).trim(), total, subjectMarks, rank };
    }

    function calculateRankForExam(dataRows, exam, studentEmisNo, studentTotalRaw) {
  const totalIdx = exam.totalIndex;
  const examNoIdx = exam.emisNoIndex;
  const subjects = exam.subjects;

  // Helper: check if a student passed ALL subjects (>75)
  function passedAll(row) {
    for (let s of subjects) {
      const mark = row[s.colIndex];
      if (mark == null || Number(mark) <= 75) return false;
    }
    return true;
  }

  const scoreList = [];

  dataRows.forEach(row => {
    // include only students who passed ALL subjects
    if (!passedAll(row)) return;

    const totalVal = row[totalIdx];
    if (totalVal == null) return;
    const num = Number(totalVal);
    if (Number.isNaN(num)) return;

    const exNoCell = row[emisNoIdx];
    if (exNoCell == null) return;
    const exNo = String(exNoCell).trim();

    scoreList.push({ emisNo: exNo, total: num });
  });

  if (!scoreList.length) return "-";

  // sort top to bottom
  scoreList.sort((a, b) => b.total - a.total);

  // if THIS student didn't pass, return "-"
  const studentRow = dataRows.find(r => String(r[emisNoIdx]).trim() === studentEmisNo);
  if (!studentRow || !passedAll(studentRow)) return "-";

  for (let i = 0; i < scoreList.length; i++) {
    if (scoreList[i].emisNo === studentEmisNo) {
      return i + 1;
    }
  }
  
  return "-";
}

    function renderResultTable(emisNo, studentName, examResults) {
      const subjectSet = new Set();
      examResults.forEach(er => {
        const exam = er.exam;
        exam.subjects.forEach(sub => subjectSet.add(sub.name));
      });
      const subjects = Array.from(subjectSet);

      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");

      const th0 = document.createElement("th");
      th0.textContent = "Subject / Exam";
      th0.style.textAlign = "left";
      trHead.appendChild(th0);

      examResults.forEach(er => {
        const th = document.createElement("th");
        th.textContent = er.exam.label;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

    const tbody = document.createElement("tbody");

      subjects.forEach(subName => {
        const tr = document.createElement("tr");
        const tdLabel = document.createElement("td");
        tdLabel.textContent = subName;
        tdLabel.className = "row-label";
        tr.appendChild(tdLabel);

        examResults.forEach(er => {
          const td = document.createElement("td");
          const res = er.result;
          if (res && res.subjectMarks && subName in res.subjectMarks) {
            const val = res.subjectMarks[subName];
            td.textContent = (val === "" || val == null) ? "-" : val;
          } else {
            td.textContent = "-";
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      const trTotal = document.createElement("tr");
      trTotal.className = "total-row";
      const tdTotalLabel = document.createElement("td");
      tdTotalLabel.textContent = "Total";
      tdTotalLabel.className = "row-label";
      trTotal.appendChild(tdTotalLabel);

      examResults.forEach(er => {
        const td = document.createElement("td");
        const res = er.result;
        td.textContent = res && res.total !== "" && res.total != null ? res.total : "-";
        trTotal.appendChild(td);
      });
      tbody.appendChild(trTotal);

      const trRank = document.createElement("tr");
      trRank.className = "rank-row";
      const tdRankLabel = document.createElement("td");
      tdRankLabel.textContent = "Rank (within class)";
      tdRankLabel.className = "row-label";
      trRank.appendChild(tdRankLabel);

      examResults.forEach(er => {
        const td = document.createElement("td");
        const res = er.result;
        td.textContent = res && res.rank ? res.rank : "-";
        trRank.appendChild(td);
      });
      tbody.appendChild(trRank);

      table.appendChild(thead);
      table.appendChild(tbody);

      studentNameEl.textContent = studentName || "(Name not available)";
      studentExamNoEl.textContent = emisNo;
      examLabelSmall.textContent =
        examResults.map(er => er.exam.label).join(" | ");

      tableWrapper.innerHTML = "";
      tableWrapper.appendChild(table);

      resultArea.style.display = "block";
      resultArea.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    
        function launchStars(success) {
      const count = success ? 18 : 8;
      const emojis = success ? ["‚≠ê", "üåü", "‚ú®", "üí´"] : ["‚ú®", "‚≠ê"];

      for (let i = 0; i < count; i++) {
        const star = document.createElement("span");
        star.className = "star";
        star.textContent = emojis[Math.floor(Math.random() * emojis.length)];

        const startX = Math.random() * 100;
        const delay = Math.random() * 0.4;
        const duration = 1.4 + Math.random() * 0.7;

        star.style.left = startX + "vw";
        star.style.animationDelay = delay + "s";
        star.style.animationDuration = duration + "s";
document.body.appendChild(star);
        star.addEventListener("animationend", () => star.remove());
      }
    }
  </script>
</body>
</html>
