<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Student Result Viewer</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .exam-pill {
        display: inline-block; 
        padding: 8px 16px;
        margin: 6px;
        border-radius: 20px;
        background: #e0e0ff;
        cursor: pointer;
        border: 1px solid #888;
    }
    .exam-pill.active {
        background: #4b7bff;
        color: white;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    table, th, td {
        border: 1px solid #444;
        padding: 6px;
    }
</style>
</head>

<body>

<h2>Student Result Viewer</h2>

<div id="examContainer"></div>
<div id="resultContainer"></div>

<script>
/* -----------------------------
   CONFIG
------------------------------*/
const SHEET_ID = "17Lupgg8a6AKXfcu_WrSElxfZ1XKuxS1O8bBXpEv5DM4"; 
const SHEET_NAME = "Sheet1";   // Change if needed

const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* -----------------------------
   FETCH SHEET SAFELY
------------------------------*/
async function fetchSheet() {
    try {
        const response = await fetch(GVIZ_URL);
        let text = await response.text();

        // Extract JSON from Googleâ€™s wrapper
        const json = JSON.parse(
            text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1)
        );

        return json.table;
    } catch (err) {
        console.error("Fetch Error:", err);
        alert("Error fetching data. Ensure the sheet is PUBLISHED and shared as 'Anyone with link can view'.");
        return null;
    }
}

/* -----------------------------
   PROCESS COLUMNS INTO EXAM BLOCKS
------------------------------*/
function detectExamBlocks(cols) {
    let blocks = [];
    let start = null;

    for (let i = 0; i < cols.length; i++) {
        let name = cols[i].label.trim().toLowerCase();

        if (name === "emis no" || name === "emisno") {
            start = i;
        }
        if (name === "total" && start !== null) {
            blocks.push({ startCol: start, endCol: i });
            start = null;
        }
    }
    return blocks;
}

/* -----------------------------
   BUILD EXAM SELECTION BUTTONS
------------------------------*/
function renderExamButtons(blocks) {
    const cont = document.getElementById("examContainer");
    cont.innerHTML = "";

    blocks.forEach((b, idx) => {
        const div = document.createElement("div");
        div.className = "exam-pill";
        div.innerText = "Exam " + (idx + 1);

        div.onclick = () => {
            document.querySelectorAll(".exam-pill").forEach(x => x.classList.remove("active"));
            div.classList.add("active");
            loadExam(idx);
        };

        cont.appendChild(div);
    });
}

/* -----------------------------
   LOAD SELECTED EXAM INTO TABLE
------------------------------*/
function loadExam(examIndex) {
    if (!window.DATA) return;

    const table = window.DATA;
    const block = window.BLOCKS[examIndex];

    let html = "<table><tr>";

    // Headers
    for (let c = block.startCol; c <= block.endCol; c++) {
        html += `<th>${table.cols[c].label}</th>`;
    }
    html += "</tr>";

    // Rows
    table.rows.forEach(row => {
        html += "<tr>";
        for (let c = block.startCol; c <= block.endCol; c++) {
            const cell = row.c[c];
            html += `<td>${cell ? cell.v : ""}</td>`;
        }
        html += "</tr>";
    });

    html += "</table>";

    document.getElementById("resultContainer").innerHTML = html;
}

/* -----------------------------
   MAIN BOOTSTRAP
------------------------------*/
async function init() {
    const data = await fetchSheet();
    if (!data) return;

    window.DATA = data;
    window.BLOCKS = detectExamBlocks(data.cols);

    if (window.BLOCKS.length === 0) {
        alert("No exam blocks detected. Check if columns contain: Emis No ... Total");
        return;
    }

    renderExamButtons(window.BLOCKS);
}

init();
</script>

</body>
</html>
