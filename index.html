<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Class 6 to 9 THIRAN ‚Äì Multi-Exam Result Viewer</title>
  <style>
    :root {
      --primary: #2563eb;
      --accent: #f97316;
      --bg-dark: #020617;
      --card-bg: rgba(15,23,42,0.96);
      --text-main: #e5e7eb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(8,47,73,0.98));
      border-radius: 24px;
      box-shadow: 0 24px 70px rgba(15,23,42,0.9);
      padding: 20px 18px 22px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(96,165,250,0.28), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(251,191,36,0.24), transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(34,197,94,0.18), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      font-size: clamp(1.6rem, 3.2vw, 2.2rem);
      display: flex;
      align-items: center;
      gap: 10px;
      color: #f9fafb;
    }

    h1 span.logo {
      display: inline-flex;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0%, #fde68a, #f97316);
      box-shadow: 0 0 22px rgba(251,191,36,0.8);
      font-size: 22px;
    }

    .subtitle {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 18px 45px rgba(15,23,42,0.9);
      margin-bottom: 14px;
    }

    .welcome {
      font-size: 0.9rem;
      color: #cbd5f5;
      margin-bottom: 10px;
    }

    .welcome span {
      color: #facc15;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,2fr) minmax(0,1.2fr);
      gap: 12px;
      align-items: end;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #cbd5f5;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    input[type="text"] {
      width: 100%;
      border-radius: 999px;
      padding: 9px 13px;
      font-size: 0.95rem;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.94);
      color: #e5e7eb;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: #4ade80;
      box-shadow: 0 0 0 1px rgba(74,222,128,0.7);
    }

    .exam-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .exam-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
    }

    .exam-pill:hover {
      transform: translateY(-1px);
      border-color: #fbbf24;
    }

    .exam-pill input {
      accent-color: #facc15;
      cursor: pointer;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at 10% -10%, #f97316, #facc15);
      color: #111827;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(251,191,36,0.6);
      width: 100%;
      font-size: 0.96rem;
      transition: all 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px) scale(1.02);
      filter: brightness(1.1);
    }

    #status {
      margin-top: 8px;
      min-height: 1.2em;
      font-size: 0.84rem;
      color: #facc15;
    }

    .result-wrapper {
      display: grid;
      grid-template-columns: minmax(0,2.5fr) minmax(0,1.4fr);
      gap: 12px;
    }

    .result-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 18px 45px rgba(15,23,42,0.9);
    }

    .result-card h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .student-meta {
      font-size: 0.9rem;
      color: #e5e7eb;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(15,23,42,0.6);
      border-radius: 10px;
    }

    .student-meta strong {
      color: #facc15;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
      background: rgba(15,23,42,0.98);
      border-radius: 12px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(90deg, #0ea5e9, #22c55e);
      color: #0f172a;
    }

    th, td {
      padding: 8px 10px;
      text-align: center;
    }

    th:first-child, td:first-child {
      text-align: left;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.96);
    }

    tbody tr:hover {
      background: rgba(37,99,235,0.45);
    }

    .total-row td {
      font-weight: 700;
      color: #fbbf24;
      background: rgba(30,64,175,0.85) !important;
    }

    @media (max-width: 840px) {
      .form-grid, .result-wrapper {
        grid-template-columns: 1fr;
      }
      .student-meta {
        grid-template-columns: 1fr;
      }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .star {
      position: fixed;
      bottom: -20px;
      font-size: 22px;
      color: #facc15;
      text-shadow: 0 0 14px rgba(250,204,21,0.9);
      opacity: 0;
      pointer-events: none;
      animation: flyUp 1.8s ease-out forwards;
      z-index: 50;
    }

    @keyframes flyUp {
      0% { transform: translateY(0) scale(0.7); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(-120vh) scale(0.9) rotate(-15deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-row">
      <div>
        <h1><span class="logo">‚òÖ</span> AGMHSS PATTEESWARAM ‚Äì THIRAN Results</h1>
        <div class="subtitle">Class 6 to 9 ‚Ä¢ Compare your exam performance across months</div>
      </div>
      <div class="badge"><span class="badge-dot"></span> Live from Google Sheets</div>
    </div>

    <div class="card">
      <div class="welcome">
        Dear student, enter your <span>EMIS Number</span> and select exams to compare.
      </div>
      <div class="form-grid">
        <div>
          <label for="emisNoInput">EMIS Number</label>
          <input id="emisNoInput" type="text" placeholder="e.g. 1234567890" maxlength="12" />
        </div>
        <div>
          <label>Select Exams</label>
          <div id="examOptions" class="exam-options">Loading exams...</div>
        </div>
        <div>
          <button id="showBtn">Show My Results</button>
        </div>
      </div>
      <div id="status"></div>
    </div>

    <div id="resultArea" style="display:none;">
      <div class="result-wrapper">
        <div class="result-card">
          <h2>Marks Comparison <span id="examLabelSmall" style="font-size:0.8rem;opacity:0.9;"></span></h2>
          <div class="student-meta">
            <span><strong>Name:</strong> <span id="studentName">‚Äî</span></span>
            <span><strong>EMIS No:</strong> <span id="studentEmisNo">‚Äî</span></span>
            <span><strong>Class & Sec:</strong> <span id="studentClass">‚Äî</span></span>
          </div>
          <div id="tableWrapper"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIG =================
    const SHEET_ID   = "1RkGzPu3KkP5FRZqPMgmIYVbu2--y-NobJMpbNo-GgIc";
    const SHEET_NAME = "Thiran";

    const EXAM_NAMES = ["July", "August", "September", "November", "December", "January", "February", "March"];
    // =========================================

    let sheetCols = [];
    let sheetRows = [];
    let exams = [];

    const elements = {
      emisNoInput: document.getElementById("emisNoInput"),
      showBtn: document.getElementById("showBtn"),
      status: document.getElementById("status"),
      examOptions: document.getElementById("examOptions"),
      resultArea: document.getElementById("resultArea"),
      tableWrapper: document.getElementById("tableWrapper"),
      studentName: document.getElementById("studentName"),
      studentEmisNo: document.getElementById("studentEmisNo"),
      studentClass: document.getElementById("studentClass"),
      examLabelSmall: document.getElementById("examLabelSmall")
    };

    document.addEventListener("DOMContentLoaded", () => {
      loadSheetData();
      elements.showBtn.addEventListener("click", onShowClick);
      elements.emisNoInput.addEventListener("keyup", e => e.key === "Enter" && onShowClick());
    });

    async function loadSheetData() {
      try {
        elements.status.textContent = "Loading data from Google Sheets...";
        const url = `https://docs.google.com/spreadsheets/d/\( {SHEET_ID}/gviz/tq?tqx=out:json&sheet= \){encodeURIComponent(SHEET_NAME)}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47, text.length - 2)); // Remove wrapper

        sheetCols = json.table.cols.map(c => (c.label || "").trim());
        sheetRows = json.table.rows.map(r => r.c.map(cell => cell ? cell.v : null));

        detectExamBlocks();
        if (exams.length === 0) {
          elements.status.textContent = "No exam blocks found. Check sheet structure.";
          return;
        }

        buildExamOptions();
        elements.status.textContent = "Ready! Enter EMIS number and select exams.";
      } catch (err) {
        console.error(err);
        elements.status.textContent = "Error loading data. Check Sheet ID and publishing.";
      }
    }

    function detectExamBlocks() {
      exams = [];
      const headers = sheetCols;

      let blockIndex = 0;
      for (let i = 0; i < headers.length; i++) {
        if (headers[i] && headers[i].toLowerCase().includes("emis no")) {
          const startCol = i;
          const nextStart = sheetCols.slice(i + 1).findIndex(h => h && h.toLowerCase().includes("emis no"));
          const endCol = nextStart === -1 ? headers.length - 1 : i + nextStart + 1;

          const block = {
            id: blockIndex,
            label: EXAM_NAMES[blockIndex] || `Exam ${blockIndex + 1}`,
            startCol,
            endCol,
            emisNoIndex: i,
            nameIndex: null,
            classIndex: null,
            totalIndex: null,
            subjects: []
          };

          // Scan columns in this block
          for (let c = startCol + 1; c <= endCol; c++) {
            const label = headers[c] || "";
            const lower = label.toLowerCase();

            if (lower === "name" || lower.includes("student name")) block.nameIndex = c;
            else if (lower.includes("class") && (lower.includes("sec") || label.includes("&"))) block.classIndex = c;
            else if (lower.includes("total")) block.totalIndex = c;
            else if (label && !lower.includes("rank") && !lower.includes("emis")) {
              block.subjects.push({ name: label, colIndex: c });
            }
          }

          if (block.nameIndex !== null && block.totalIndex !== null && block.subjects.length > 0) {
            exams.push(block);
            blockIndex++;
          }
        }
      }
    }

    function buildExamOptions() {
      elements.examOptions.innerHTML = "";
      exams.forEach((exam, idx) => {
        const label = document.createElement("label");
        label.className = "exam-pill";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = idx;

        const span = document.createElement("span");
        span.textContent = exam.label;

        label.append(checkbox, span);
        elements.examOptions.appendChild(label);
      });
    }

    function onShowClick() {
      const emisNo = elements.emisNoInput.value.trim();
      if (!emisNo) return elements.status.textContent = "Please enter EMIS number.";

      const selected = Array.from(elements.examOptions.querySelectorAll("input:checked"))
        .map(cb => parseInt(cb.value));

      if (selected.length === 0) return elements.status.textContent = "Select at least one exam.";

      const results = [];
      let studentName = "";
      let studentClass = "";

      selected.forEach(idx => {
        const exam = exams[idx];
        const row = sheetRows.find(r => r[exam.emisNoIndex] != null && String(r[exam.emisNoIndex]).trim() === emisNo);
        if (row) {
          const name = row[exam.nameIndex] || "";
          const cls = exam.classIndex !== null ? row[exam.classIndex] || "" : "";
          const total = row[exam.totalIndex] || "";
          const marks = {};
          exam.subjects.forEach(sub => {
            marks[sub.name] = row[sub.colIndex] ?? "";
          });

          if (!studentName) studentName = name;
          if (!studentClass && cls) studentClass = cls;

          results.push({ exam, result: { name, total, marks } });
        } else {
          results.push({ exam, result: null });
        }
      });

      if (results.every(r => !r.result)) {
        elements.status.textContent = "EMIS number not found in selected exams.";
        elements.resultArea.style.display = "none";
        return;
      }

      renderResults(emisNo, studentName, studentClass, results);
      elements.status.textContent = "";
      launchStars(true);
    }

    function renderResults(emisNo, name, cls, examResults) {
      const subjects = new Set();
      examResults.forEach(er => er.exam.subjects.forEach(s => subjects.add(s.name)));
      const subjectList = Array.from(subjects);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      const headRow = document.createElement("tr");
      const thSubject = document.createElement("th");
      thSubject.textContent = "Subject";
      headRow.appendChild(thSubject);

      examResults.forEach(er => {
        const th = document.createElement("th");
        th.textContent = er.exam.label;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      subjectList.forEach(sub => {
        const tr = document.createElement("tr");
        const tdSub = document.createElement("td");
        tdSub.textContent = sub;
        tdSub.style.fontWeight = "600";
        tr.appendChild(tdSub);

        examResults.forEach(er => {
          const td = document.createElement("td");
          if (er.result && er.result.marks[sub] !== undefined) {
            td.textContent = er.result.marks[sub] || "-";
          } else {
            td.textContent = "-";
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // Total Row
      const totalRow = document.createElement("tr");
      totalRow.className = "total-row";
      const totalLabel = document.createElement("td");
      totalLabel.textContent = "Total";
      totalLabel.style.fontWeight = "700";
      totalRow.appendChild(totalLabel);

      examResults.forEach(er => {
        const td = document.createElement("td");
        td.textContent = er.result ? (er.result.total || "-") : "-";
        totalRow.appendChild(td);
      });
      tbody.appendChild(totalRow);

      table.appendChild(tbody);

      elements.studentName.textContent = name || "Name not found";
      elements.studentEmisNo.textContent = emisNo;
      elements.studentClass.textContent = cls || "Not available";
      elements.examLabelSmall.textContent = examResults.map(r => r.exam.label).join(" vs ");

      elements.tableWrapper.innerHTML = "";
      elements.tableWrapper.appendChild(table);
      elements.resultArea.style.display = "block";
      elements.resultArea.scrollIntoView({ behavior: "smooth" });
    }

    function launchStars(success = true) {
      const count = success ? 20 : 10;
      const emojis = success ? ["‚≠ê", "üåü", "‚ú®", "üí´", "üéâ"] : ["üíî", "üò¢"];
      for (let i = 0; i < count; i++) {
        const star = document.createElement("div");
        star.className = "star";
        star.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        star.style.left = Math.random() * 100 + "vw";
        star.style.animationDelay = Math.random() * 0.5 + "s";
        document.body.appendChild(star);
        star.addEventListener("animationend", () => star.remove());
      }
    }
  </script>
</body>
</html>
